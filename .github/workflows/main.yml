name: JMeter CI/CD Workflow

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  # ✅ JMeter Tests
  jmeter-tests:
    runs-on: ubuntu-latest

    steps:
      # ✅ Checkout the repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # ✅ Install JMeter
      - name: Install JMeter
        run: |
          sudo apt update
          sudo apt install -y openjdk-11-jre
          wget https://archive.apache.org/dist/jmeter/binaries/apache-jmeter-5.6.2.tgz
          tar -xvzf apache-jmeter-5.6.2.tgz
          echo "JMETER_HOME=$(pwd)/apache-jmeter-5.6.2" >> $GITHUB_ENV
          echo "$(pwd)/apache-jmeter-5.6.2/bin" >> $GITHUB_PATH

      # ✅ Reload environment variables
      - name: Load environment variables
        run: source $GITHUB_ENV

      # ✅ Verify JMeter installation
      - name: Verify JMeter Installation
        run: |
          jmeter --version

      # ✅ Create report directories
      - name: Create report directories
        run: |
          mkdir -p ./jmeter-pages/reports
          mkdir -p ./jmeter-tests/results

      # ✅ Run JMeter Tests
      - name: Run JMeter Tests
        run: |
          jmeter -n \
            -t ./C_1.jmx \
            -l ./jmeter-tests/results/results.jtl \
            -e -o ./jmeter-pages/reports \
            -Jthreads=100 -Jrampup=10 -Jduration=60 -f

      # ✅ Inject Correct Base URL for GitHub Pages
      - name: Inject Base URL
        run: |
          find ./jmeter-pages/reports -name "*.html" -exec sed -i 's#<head>#<head><base href="/chaabi-jmeter-tests/reports/">#g' {} +

      # ✅ Display Test Summary
      - name: Display Test Summary
        run: |
          echo "Test Summary:"
          grep "summary =" ./jmeter-tests/results/results.jtl || echo "No summary found"

      # ✅ Upload Reports as Artifacts
      - name: Upload JMeter Reports
        uses: actions/upload-artifact@v4
        with:
          name: JMeter-Reports
          path: ./jmeter-pages/reports

  # ✅ GitHub Pages Deployment
  deploy:
    needs: jmeter-tests
    runs-on: ubuntu-latest

    steps:
      # ✅ Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # ✅ Download JMeter Reports Artifact
      - name: Download JMeter Reports
        uses: actions/download-artifact@v4
        with:
          name: JMeter-Reports
          path: ./jmeter-pages/reports

      # ✅ Prepare GitHub Pages Deployment
      - name: Prepare GitHub Pages Deployment
        run: |
          mkdir -p ./public
          mv ./jmeter-pages/reports/* ./public/            # Move reports to /public
          cp ./public/index.html ./public/404.html         # Prevent 404 errors

      # ✅ Deploy to GitHub Pages
      - name: Deploy to GitHub Pages
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          branch: gh-pages                # Target branch for GitHub Pages
          folder: ./public                # Folder containing the HTML reports
          token: ${{ secrets.GITHUB_TOKEN }}
          clean: true
          force: true
          attempt-limit: 3
