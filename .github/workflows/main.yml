name: JMeter CI/CD Workflow

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  jmeter-tests:
    runs-on: ubuntu-latest

    steps:
      # Checkout code
      - name: Checkout repository
        uses: actions/checkout@v4

      # Install JMeter
      - name: Install JMeter
        run: |
          sudo apt update
          sudo apt install -y openjdk-11-jre
          wget https://archive.apache.org/dist/jmeter/binaries/apache-jmeter-5.6.2.tgz
          tar -xvzf apache-jmeter-5.6.2.tgz
          echo "JMETER_HOME=$(pwd)/apache-jmeter-5.6.2" >> $GITHUB_ENV
          echo "$JMETER_HOME/bin" >> $GITHUB_PATH

      # Verify JMeter Installation
      - name: Verify JMeter Installation
        run: |
          jmeter --version

      # Create reports and results folders
      - name: Create report directories
        run: |
          mkdir -p ./jmeter-tests/reports
          mkdir -p ./jmeter-tests/results

      # Run JMeter Test
      - name: Run JMeter Tests
        run: |
          jmeter -n -t ./jmeter-tests/E_1_FF.jmx \
                 -l ./jmeter-tests/results/results.jtl \
                 -e -o ./jmeter-tests/reports \
                 -Jthreads=100 -Jrampup=10 -Jduration=60 -f

      # Display Test Summary
      - name: Display Test Summary
        run: |
          echo "Test Summary:"
          grep "summary =" ./jmeter-tests/results/results.jtl || echo "No summary found"

      # Upload Reports and Logs
      - name: Upload Reports and Logs
        uses: actions/upload-artifact@v4
        with:
          name: JMeter-Reports
          path: |
            ./jmeter-tests/reports/
            ./jmeter-tests/results/results.jtl
            ./jmeter-tests/jmeter.log
