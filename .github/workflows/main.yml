name: JMeter Test Workflow

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:  # Allow manual triggering

jobs:
  jmeter-tests:
    runs-on: ubuntu-latest

    steps:
      # ✅ Checkout the repository
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # This ensures we get the full history for commits

      # ✅ Install JMeter
      - name: Install JMeter
        run: |
          sudo apt update
          sudo apt install -y openjdk-11-jre
          wget https://archive.apache.org/dist/jmeter/binaries/apache-jmeter-5.6.2.tgz
          tar -xvzf apache-jmeter-5.6.2.tgz
          echo "JMETER_HOME=$(pwd)/apache-jmeter-5.6.2" >> $GITHUB_ENV
          echo "$(pwd)/apache-jmeter-5.6.2/bin" >> $GITHUB_PATH

      # ✅ Install dependencies for history update
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq  # Install jq for JSON processing

      # ✅ Reload environment variables
      - name: Load environment variables
        run: source $GITHUB_ENV

      # ✅ Verify JMeter installation
      - name: Verify JMeter Installation
        run: |
          jmeter --version

      # ✅ Setup Node.js for deletion API
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: scripts/package.json

      # ✅ Install Node.js dependencies
      - name: Install Node.js dependencies
        run: |
          cd scripts
          npm install

      # ✅ Create report directories
      - name: Create report directories
        run: |
          mkdir -p ./jmeter-pages/reports
          mkdir -p ./jmeter-tests/results
          mkdir -p ./jmeter-pages/history
          mkdir -p ./jmeter-pages/comparison
          chmod -R 755 ./jmeter-pages
          mkdir -p ./reports/$(date +"%Y-%m-%d_%H-%M-%S")

      # ✅ Download previous results if they exist
      - name: Download previous results
        id: download-previous
        continue-on-error: true  # Continue even if no previous results
        uses: actions/download-artifact@v4
        with:
          name: JMeter-History
          path: ./jmeter-pages/history
          retention-days: 30  # Keep artifacts for 30 days

      # ✅ Create empty history file if no previous results
      - name: Create empty history file if needed
        run: |
          if [ ! -f "./jmeter-pages/history/history.json" ]; then
            echo "No previous history file found. Creating an empty one."
            mkdir -p ./jmeter-pages/history
            echo '{"tests":[]}' > ./jmeter-pages/history/history.json
          fi

      # ✅ Run JMeter Tests
      - name: Run JMeter Tests
        run: |
          jmeter -n \
            -t ./C_1.jmx \
            -l ./jmeter-tests/results/results.jtl \
            -e -o ./jmeter-pages/reports \
            -Jthreads=100 -Jrampup=10 -Jduration=60 -f
          
          # Copy results to reports directory for history tracking
          TIMESTAMP=$(date +"%Y-%m-%d_%H-%M-%S")
          mkdir -p ./reports/$TIMESTAMP/JMeterTest
          cp ./jmeter-tests/results/results.jtl ./reports/$TIMESTAMP/
          
          # Create statistics.json file
          echo "{" > ./reports/$TIMESTAMP/JMeterTest/statistics.json
          echo "  \"Total\": {" >> ./reports/$TIMESTAMP/JMeterTest/statistics.json
          echo "    \"transaction\": \"Total\"," >> ./reports/$TIMESTAMP/JMeterTest/statistics.json
          echo "    \"sampleCount\": $(grep -c "" ./jmeter-tests/results/results.jtl)," >> ./reports/$TIMESTAMP/JMeterTest/statistics.json
          echo "    \"errorCount\": $(grep -c ",false," ./jmeter-tests/results/results.jtl)," >> ./reports/$TIMESTAMP/JMeterTest/statistics.json
          ERROR_COUNT=$(grep -c ",false," ./jmeter-tests/results/results.jtl)
          SAMPLE_COUNT=$(grep -c "" ./jmeter-tests/results/results.jtl)
          ERROR_PCT=$(awk "BEGIN {print ($ERROR_COUNT/$SAMPLE_COUNT)*100}")
          echo "    \"errorPct\": $ERROR_PCT," >> ./reports/$TIMESTAMP/JMeterTest/statistics.json
          MEAN_TIME=$(awk -F "," '{sum+=$1} END {print sum/NR}' ./jmeter-tests/results/results.jtl)
          echo "    \"meanResTime\": $MEAN_TIME" >> ./reports/$TIMESTAMP/JMeterTest/statistics.json
          echo "  }" >> ./reports/$TIMESTAMP/JMeterTest/statistics.json
          echo "}" >> ./reports/$TIMESTAMP/JMeterTest/statistics.json

      # ✅ Make scripts executable
      - name: Make scripts executable
        run: |
          chmod +x ./scripts/generate_history.sh || true
          chmod +x ./scripts/run_comparison.sh || true
          chmod +x ./scripts/launch_comparison_viewer.sh || true
          chmod +x ./scripts/update_history.sh || true

      # ✅ Update history file
      - name: Update history file
        run: |
          if [ -f "./scripts/update_history.sh" ]; then
            ./scripts/update_history.sh
          else
            echo "Warning: update_history.sh script not found"
          fi

      # ✅ Copy history files to key locations
      - name: Copy history files to key locations
        run: |
          mkdir -p reports/history
          mkdir -p scripts/history
          mkdir -p history
          
          # Copy files if they exist
          [ -f "scripts/history/history.json" ] && cp scripts/history/history.json reports/history/history.json || true
          [ -f "scripts/history/history.json" ] && cp scripts/history/history.json history/history.json || true
          [ -f "scripts/history/history.json" ] && cp scripts/history/history.json ./jmeter-pages/history/history.json || true

      # ✅ Copy comparison files
      - name: Copy comparison files
        run: |
          # Copy comparison viewer files if they exist
          if [ -f "scripts/comparison_viewer.html" ]; then
            mkdir -p ./jmeter-pages/comparison
            cp scripts/comparison_viewer.html ./jmeter-pages/comparison/index.html || true
            cp scripts/comparison_viewer.js ./jmeter-pages/comparison/ || true
          fi
          
          # Create a simple comparison page if the files don't exist
          if [ ! -f "./jmeter-pages/comparison/index.html" ]; then
            mkdir -p ./jmeter-pages/comparison
            cat > ./jmeter-pages/comparison/index.html << 'EOL'
            <!DOCTYPE html>
            <html lang="en">
            <head>
                <meta charset="UTF-8">
                <meta name="viewport" content="width=device-width, initial-scale=1.0">
                <title>JMeter Test Comparison</title>
                <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
            </head>
            <body>
                <div class="container mt-5">
                    <h1>JMeter Test Comparison</h1>
                    <p>This page allows you to compare JMeter test results.</p>
                    <p>View the <a href="../history/">history dashboard</a> or <a href="../reports/">test reports</a>.</p>
                </div>
            </body>
            </html>
            EOL
          fi

      # ✅ Run comparison setup (history data generation + comparison tool)
      - name: Set up Comparison Tool
        run: |
          # Ensure history directory exists and has proper permissions
          mkdir -p ./jmeter-pages/history
          chmod -R 755 ./jmeter-pages/history
          ./scripts/run_comparison.sh ./jmeter-tests/results/results.jtl || true

      # ✅ Display Test Summary
      - name: Display Test Summary
        run: |
          echo "Test Summary:"
          grep "summary =" ./jmeter-tests/results/results.jtl || echo "No summary found"

      # ✅ Upload Reports as Artifacts
      - name: Upload JMeter Reports
        uses: actions/upload-artifact@v4
        with:
          name: JMeter-Reports
          path: ./jmeter-pages/reports
          retention-days: 30  # Keep artifacts for 30 days

      # ✅ Upload Historical Data as Artifacts
      - name: Upload Historical Data
        uses: actions/upload-artifact@v4
        with:
          name: JMeter-History
          path: |
            ./jmeter-pages/history
            ./scripts/history
            ./reports/history
          retention-days: 30  # Keep artifacts for 30 days

      # ✅ Upload Comparison Tools as Artifacts
      - name: Upload Comparison Tools
        uses: actions/upload-artifact@v4
        with:
          name: JMeter-Comparison
          path: ./jmeter-pages/comparison
          retention-days: 30  # Keep artifacts for 30 days

      # ✅ Commit and push changes
      - name: Commit and push changes
        uses: EndBug/add-and-commit@v9
        with:
          add: 'history/*.json reports/history/*.json scripts/history/*.json reports/'
          message: 'Update test history [skip ci]'
          default_author: github_actions

  # ✅ GitHub Pages Deployment
  deploy:
    needs: jmeter-tests
    runs-on: ubuntu-latest

    steps:
      # ✅ Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # ✅ Download JMeter Reports Artifact
      - name: Download JMeter Reports
        uses: actions/download-artifact@v4
        with:
          name: JMeter-Reports
          path: ./jmeter-pages/reports

      # ✅ Download Historical Data Artifact
      - name: Download Historical Data
        uses: actions/download-artifact@v4
        with:
          name: JMeter-History
          path: ./jmeter-pages/history

      # ✅ Download Comparison Tools Artifact
      - name: Download Comparison Tools
        uses: actions/download-artifact@v4
        with:
          name: JMeter-Comparison
          path: ./jmeter-pages/comparison

      # ✅ Prepare for GitHub Pages
      - name: Prepare GitHub Pages Structure
        run: |
          # Create public directory
          mkdir -p ./public
          
          # Copy reports to public/reports
          mkdir -p ./public/reports
          cp -r ./jmeter-pages/reports/* ./public/reports/
          
          # Copy history data to public/history (needed for the comparison tool)
          mkdir -p ./public/history
          cp -r ./jmeter-pages/history/* ./public/history/
          
          # Copy comparison tools to public/comparison
          mkdir -p ./public/comparison
          cp -r ./jmeter-pages/comparison/* ./public/comparison/
          
          # Copy history dashboard if it exists
          [ -f "./reports/history/index.html" ] && cp ./reports/history/index.html ./public/history/ || true
          
          # Create index.html that redirects to reports
          cat > ./public/index.html << 'EOL'
          <!DOCTYPE html>
          <html>
            <head>
              <meta charset="UTF-8">
              <meta http-equiv="refresh" content="0;url=reports/">
              <title>JMeter Test Reports</title>
            </head>
            <body>
              <p>If you are not redirected automatically, follow this <a href="reports/">link to the reports</a>.</p>
              <p>View the <a href="history/">history dashboard</a> or <a href="comparison/">test comparison</a>.</p>
            </body>
          </html>
          EOL

      # ✅ Deploy to GitHub Pages
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public
          publish_branch: gh-pages
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
          full_commit_message: 'Deploy JMeter test reports from ${{ github.sha }}' 
